#!/usr/bin/env bash
# Install Ansible into a Python virtual environment
# Usage: ./install_ansible

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="${SCRIPT_DIR}/.venv"

echo "==> Bashible Setup"

# Check for Python 3
if ! command -v python3 &> /dev/null; then
    echo "ERROR: python3 is required but not found"
    echo "Install Python 3.9+ and try again"
    exit 1
fi

PYTHON_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
echo "    Found Python ${PYTHON_VERSION}"

# Create virtual environment
if [[ -f "${VENV_DIR}/bin/activate" ]]; then
    echo "    Virtual environment already exists at ${VENV_DIR}"
else
    echo "==> Creating virtual environment..."
    python3 -m venv "${VENV_DIR}"
fi

# Activate and install
echo "==> Installing dependencies..."
source "${VENV_DIR}/bin/activate"
pip install --quiet --upgrade pip
pip install --quiet -r "${SCRIPT_DIR}/requirements.txt"

# Verify installation
echo "==> Verifying installation..."
ansible --version | head -1
ansible-lint --version | head -1

echo ""
echo "==> Setup complete!"
echo ""
echo "To activate the environment:"
echo "    source ${VENV_DIR}/bin/activate"
echo ""
echo "Or use the wrapper script:"
echo "    ./ansible.sh <command>"
echo ""
echo "Quick start:"
echo "    source .venv/bin/activate"
echo "    ansible-inventory --graph"
echo "    ansible localhost -m ping"
